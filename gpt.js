import OpenAI from 'openai'
import document from './document.js'

const client = function () {
  let instance

  if (!instance) {
    instance = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY,
    })
  }

  return instance
}
const model = 'gpt-4.1'
const instructions = `
  Ты - опытный агент-юрист, специализирующийся на вопросах бракоразводного процесса.

  Твоя задача - генерировать документы для подачи в суд или другие уполномоченные органы опираясь на конституцию и законы Республики Казахстан, а также на предоставленную пользователем информацию. Не придумывай ничего нового, а используй только те данные, которые предоставляет пользователь. Если пользователь не предоставляет достаточной информации, задавай уточняющие вопросы.

  Отвечай в простом и понятном стиле, избегая сложной юридической терминологии. Твоя цель - помочь пользователю решить свою проблему.

  Не отвечай на вопросы, которые не связаны с твоими задачами, такими как юридические консультации или советы по другим вопросам.

  # Порядок действий
  1. Пользователь описывает ситуацию, связанную с разводом или отправляеть документы связанные с процессом.
  2. Ты короко описываешь что нужно сделать. Если это необходимо, ты задаешь уточняющие вопросы, также уточняешь документы, которые можно или нужно приложить к документу. Например, если пользователь говорит, что хочет подать иск о разделе имущества, ты спрашиваешь о наличии документов на имущество, свидетельствах о рождении детей и т.д.
  3. На основе полученной информации ты генерируешь документы, которые пользователь может использовать в суде или других органах. Также даешь список того что нужно вложить в документ (например, копии свидетельств о рождении детей, документы о доходах и т.д.).

  Формат ответа: Markdown, используй только форматирование текста (жирный, курсив) и списки.
  `
const tools = [
  {
    type: 'function',
    name: 'generate_document',
    description:
      'Генерирует официальный судебный документ (по законам РК) и возвращает путь к .docx файлу. Используй только если пользователь просит сформировать документ. Каждый параметр может быть строкой или массивом строк для многострочного текста.',
    parameters: {
      type: 'object',
      properties: {
        header: {
          type: 'array',
          items: { type: 'string' },
          description:
            'Титульная часть документа - массив строк (адресат, от кого, ИИН и т.д.). Каждый элемент массива - отдельная строка.',
        },
        title: {
          type: 'array',
          items: { type: 'string' },
          description:
            "Заголовок документа - массив строк (например, ['ОТЗЫВ', 'на исковое заявление']). Каждый элемент массива - отдельная строка заголовка.",
        },
        content: {
          type: 'array',
          items: { type: 'string' },
          description: 'Основное содержимое документа - массив строк. Каждый элемент массива будет новым абзацем с отступом первой строки.',
        },
        signatory: {
          type: 'array',
          items: { type: 'string' },
          description: 'Подпись - массив строк (ФИО, дата, ЭЦП если нужно). Каждый элемент массива - отдельная строка.',
        },
      },
      required: ['header', 'title', 'content', 'signatory'],
      additionalProperties: false,
    },
    strict: true,
  },
]

const gpt = {
  async generate(input) {
    const response = await client().responses.create({
      model,
      instructions,
      input,
      tools,
    })

    // Проверка на function call
    for (const item of response.output) {
      if (item.type === 'function_call' && item.name === 'generate_document') {
        const args = JSON.parse(item.arguments)

        const filePath = await document.generate(
          args.header,
          args.title,
          args.content,
          args.signatory
        )

        if (filePath) {
          return { text: 'Документ сгенерирован:', filePath }
        }
      }
    }

    return { text: response.output_text }
  },
}

export default gpt
